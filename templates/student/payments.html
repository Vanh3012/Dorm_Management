{% extends "student/student_base.html" %}
{% block content %}

<div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-2xl font-bold mb-6">Thanh to√°n h√≥a ƒë∆°n</h2>

    <!-- B·ªô l·ªçc -->
    <div class="flex flex-wrap gap-2 mb-6">
        {% set filters = {
        'all': 'T·∫•t c·∫£',
        'deposit': 'Ti·ªÅn c·ªçc',
        'room': 'Ti·ªÅn ph√≤ng',
        'utilities': 'ƒêi·ªán/N∆∞·ªõc',
        'trash': 'Thu gom r√°c',
        'maintenance': 'B·∫£o tr√¨'
        } %}
        {% for type, label in filters.items() %}
        <a href="{{ url_for('student.payments', type=type) }}" class="px-4 py-2 rounded-lg text-sm font-medium transition
           {% if current_type == type %}
               bg-red-600 text-white
           {% else %}
               bg-gray-100 hover:bg-gray-200
           {% endif %}">
            {{ label }}
        </a>
        {% endfor %}
    </div>

    <!-- B·∫£ng thanh to√°n -->
    <div class="overflow-x-auto">
        <table class="w-full border rounded-lg overflow-hidden text-sm">
            <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                <tr>
                    <th class="p-3 border">#</th>
                    <th class="p-3 border">D·ªãch v·ª•</th>
                    <th class="p-3 border">Ph√≤ng</th>
                    <th class="p-3 border">S·ªë ti·ªÅn</th>
                    <th class="p-3 border">Ng√†y t·∫°o</th>
                    <th class="p-3 border">Tr·∫°ng th√°i</th>
                    <th class="p-3 border">Thao t√°c</th>
                </tr>
            </thead>
            <tbody class="text-center">
                {% for p in payments %}
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="p-3">{{ loop.index }}</td>
                    <td class="p-3">
                        {% set label_map = {
                        'deposit': 'Ti·ªÅn c·ªçc',
                        'room': 'Ti·ªÅn ph√≤ng',
                        'utilities': 'ƒêi·ªán/N∆∞·ªõc',
                        'trash': 'Thu gom r√°c',
                        'maintenance': 'B·∫£o tr√¨'
                        } %}
                        {{ label_map.get(p.service_type, p.service_type) }}
                    </td>
                    <td class="p-3">{{ p.room.block }} - {{ p.room.room_number }}</td>
                    <td class="p-3 font-semibold text-blue-700">{{ "{:,.0f}".format(p.amount) }} ƒë</td>
                    <td class="p-3">{{ p.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
                    <td class="p-3">
                        {% if p.status == 'pending' %}
                        <span class="px-2 py-1 rounded text-xs font-semibold bg-red-100 text-red-700">Ch∆∞a thanh
                            to√°n</span>
                        {% else %}
                        <span class="px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-700">ƒê√£ thanh
                            to√°n</span>
                        {% endif %}
                    </td>
                    <td class="p-3">
                        {% if p.status == 'pending' %}
                        <button
                            onclick="openPaymentModal('{{ p.id }}', '{{ p.service_type }}', '{{ p.amount }}', '{{ p.month_paid }}', '{{ p.year_paid }}', '{{ p.room.room_number }}')"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-xs shadow-sm">
                            Thanh to√°n
                        </button>
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="p-6 text-gray-500 italic">Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Thanh to√°n -->
<div id="paymentModal"
    class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="bg-white rounded-xl w-full max-w-md shadow-xl relative p-6 space-y-4 animate-fade-in">
        <button onclick="closePaymentModal()" class="absolute top-3 right-3 text-gray-500 hover:text-black">‚úï</button>
        <h2 class="text-xl font-bold text-gray-800">Th√¥ng tin thanh to√°n</h2>

        <div class="text-sm text-gray-700 space-y-2">
            <p><b>D·ªãch v·ª•:</b> <span id="serviceType"></span></p>
            <p><b>Ph√≤ng:</b> <span id="roomInfo"></span></p>
            <p><b>S·ªë ti·ªÅn:</b> <span id="amount"></span> ƒë</p>
            <p><b>K·ª≥ thanh to√°n:</b> <span id="period"></span></p>
            <hr>
            <p><b>Ng√¢n h√†ng:</b> MB Bank ‚Äì H·ªçc Vi·ªán C√¥ng Ngh·ªá B∆∞u Ch√≠nh Vi·ªÖn Th√¥ng</p>
            <p><b>S·ªë t√†i kho·∫£n:</b> <span class="font-semibold">97042200012345</span></p>
            <p><b>N·ªôi dung chuy·ªÉn kho·∫£n:</b>
                <code id="transferContent" class="bg-gray-100 px-2 py-1 rounded text-sm"></code>
            </p>

            <div class="flex justify-center py-3">
                <img id="qrImage" src="" alt="QR Code" class="w-48 h-48 object-contain border rounded-md">
            </div>

            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded text-xs">
                üîî <b>L∆∞u √Ω:</b> Qu√©t m√£ ho·∫∑c chuy·ªÉn kho·∫£n ƒë√∫ng n·ªôi dung. Sau ƒë√≥ b·∫•m ‚ÄúHo√†n th√†nh‚Äù ƒë·ªÉ x√°c nh·∫≠n.
            </div>

            <div class="flex justify-end gap-2 pt-4">
                <button onclick="closePaymentModal()"
                    class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm">
                    ƒê√≥ng
                </button>
                <button id="confirmPaymentBtn"
                    class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm">
                    Ho√†n th√†nh thanh to√°n
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.25s ease-out;
    }
</style>

<script>
    let currentPaymentId = null;

    function removeVietnameseTones(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/ƒë/g, "d").replace(/ƒê/g, "D").toUpperCase();
    }

    const bankCode = "MB"; 
        const accountNumber = "0388573796"; 
        const accountName = "LE VIET ANH"; 

        function openPaymentModal(id, service, amount, month, year, room) {
            currentPaymentId = id;
            const map = {
                'deposit': 'Ti·ªÅn c·ªçc',
                'room': 'Ti·ªÅn ph√≤ng',
                'utilities': 'ƒêi·ªán/N∆∞·ªõc',
                'trash': 'Thu gom r√°c',
                'maintenance': 'B·∫£o tr√¨'
            };

            const studentId = "{{ current_user.student_id }}";
            const fullnameRaw = "{{ current_user.fullname }}";
            const fullnameNoAccent = removeVietnameseTones(fullnameRaw);
            const transferText = `${studentId} - ${fullnameNoAccent} - ${room}`;

            document.getElementById("serviceType").textContent = map[service] || service;
            document.getElementById("roomInfo").textContent = room;
            document.getElementById("amount").textContent = parseInt(amount).toLocaleString("vi-VN");
            document.getElementById("period").textContent = `${month}/${year}`;
            document.getElementById("transferContent").textContent = transferText;

            const qrUrl = `https://img.vietqr.io/image/${bankCode}-${accountNumber}-compact.png?amount=${amount}&addInfo=${encodeURIComponent(transferText)}&accountName=${encodeURIComponent(accountName)}`;
            document.getElementById("qrImage").src = qrUrl;

            document.getElementById("paymentModal").classList.remove("hidden");
        }

    function closePaymentModal() {
        document.getElementById("paymentModal").classList.add("hidden");
        currentPaymentId = null;
    }

    document.getElementById("confirmPaymentBtn").addEventListener("click", async () => {
            if (!currentPaymentId) return;

            const btn = document.getElementById("confirmPaymentBtn");
            btn.disabled = true;
            btn.textContent = "ƒêang x·ª≠ l√Ω...";

            try {
                const res = await fetch(`/student/pay/${currentPaymentId}`, { method: "POST" });
                const data = await res.json();

                if (data.success) {
                    closePaymentModal();
                    // Reload sau 1 gi√¢y
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(data.message || "C√≥ l·ªói khi x√°c nh·∫≠n thanh to√°n!");
                }
            } catch (err) {
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß!");
            }

            btn.disabled = false;
            btn.textContent = "Ho√†n th√†nh thanh to√°n";
        });

</script>

{% endblock %}