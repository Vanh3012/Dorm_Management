{% extends "admin/admin_base.html" %}
{% block content %}

<div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-2xl font-bold mb-4">Quản lý dịch vụ</h2>

    <!--Bộ lọc-->
    <form method="get" class="bg-white p-4 rounded-lg shadow mb-6 flex flex-wrap gap-3 items-end">
        <div>
            <label class="text-sm text-gray-600">Tháng</label>
            <input type="number" name="month" class="border rounded px-2 py-1 w-20" min="1" max="12"
                value="{{ filters.month or '' }}">
        </div>
        <div>
            <label class="text-sm text-gray-600">Năm</label>
            <input type="number" name="year" class="border rounded px-2 py-1 w-24" value="{{ filters.year or '' }}">
        </div>
        <div>
            <label class="text-sm text-gray-600">Từ ngày</label>
            <input type="date" name="date_from" class="border rounded px-2 py-1" value="{{ filters.date_from or '' }}">
        </div>
        <div>
            <label class="text-sm text-gray-600">Đến ngày</label>
            <input type="date" name="date_to" class="border rounded px-2 py-1" value="{{ filters.date_to or '' }}">
        </div>
        <div>
            <label class="text-sm text-gray-600">Trạng thái</label>
            <select name="status" class="border rounded px-2 py-1">
                <option value="">-- Tất cả --</option>
                <option value="pending" {% if filters.status=='pending' %}selected{% endif %}>Chờ xử lý</option>
                <option value="in_progress" {% if filters.status=='in_progress' %}selected{% endif %}>Đang xử lý</option>
                <option value="completed" {% if filters.status=='completed' %}selected{% endif %}>Hoàn thành</option>
                <option value="cancelled" {% if filters.status=='cancelled' %}selected{% endif %}>Đã hủy</option>
            </select>
        </div>
        <div>
            <label class="text-sm text-gray-600">Loại dịch vụ</label>
            <select name="service_type" class="border rounded px-2 py-1">
                <option value="">-- Tất cả --</option>
                <option value="maintenance" {% if filters.service_type=='maintenance' %}selected{% endif %}>Sửa chữa</option>
                <option value="trash" {% if filters.service_type=='cleaning' %}selected{% endif %}>Vệ sinh</option>
            </select>
        </div>
        <div>
            <label class="text-sm text-gray-600">Từ (VNĐ)</label>
            <input type="number" name="min_cost" class="border rounded px-2 py-1 w-28" value="{{ filters.min_cost or '' }}">
        </div>
        <div>
            <label class="text-sm text-gray-600">Đến (VNĐ)</label>
            <input type="number" name="max_cost" class="border rounded px-2 py-1 w-28" value="{{ filters.max_cost or '' }}">
        </div>
        <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Lọc</button>
        <a href="{{ url_for('admin.manage_services') }}" class="text-gray-500 underline text-sm">Xóa lọc</a>
    </form>


    <table class="w-full border text-sm text-center">
        <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
            <tr>
                <th class="px-4 py-2">ID</th>
                <th class="px-4 py-2">Sinh viên</th>
                <th class="px-4 py-2">Phòng</th>
                <th class="px-4 py-2">Dịch vụ</th>
                <th class="px-4 py-2">Mô tả</th>
                <th class="px-4 py-2">Giá tiền</th>
                <th class="px-4 py-2">Trạng thái</th>
                <th class="px-4 py-2">Ngày</th>
                <th class="px-4 py-2">Hành động</th>
            </tr>
        </thead>
        <tbody>
            {% for req in service_requests %}
            <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-2 font-medium">{{ req.id }}</td>
                <td class="px-4 py-2">{{ req.user.fullname }}<br><span class="text-xs text-gray-500">{{
                        req.user.student_id }}</span></td>
                <td class="px-4 py-2">
                    {% if req.room %} {{ req.room.block }} - {{ req.room.room_number }}
                    {% else %} -
                    {% endif %}
                </td>
                <td class="px-4 py-2">
                    {% if req.service_type == "trash" %} Thu gom rác
                    {% elif req.service_type == "maintenance" %} Bảo trì sửa chữa
                    {% endif %}
                </td>
                <td class="px-4 py-2 text-left">{{ req.description or "-" }}</td>
                <td class="px-4 py-2 font-semibold text-blue-700">
                    {% if req.service_type == "maintenance" %}
                    <form action="{{ url_for('admin.set_service_price', req_id=req.id) }}" method="POST"
                        class="flex gap-2 items-center justify-center">
                        <input type="number" name="price" value="{{ req.price or '' }}"
                            class="w-24 border rounded px-2 py-1 text-sm" placeholder="VNĐ">
                        <button type="submit"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs px-2 py-1 rounded">
                            Lưu
                        </button>
                    </form>
                    {% else %}
                    {{ "{:,.0f}".format(req.price) }}đ
                    {% endif %}
                </td>
                <td class="px-4 py-2">
                    {% if req.status == "pending" %}
                    <span class="px-2 py-1 rounded text-xs font-semibold bg-yellow-100 text-yellow-800">Chờ xử lý</span>
                    {% elif req.status == "in_progress" %}
                    <span class="px-2 py-1 rounded text-xs font-semibold bg-blue-100 text-blue-800">Đang xử lý</span>
                    {% elif req.status == "completed" %}
                    <span class="px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-800">Hoàn thành</span>
                    {% elif req.status == "rejected" %}
                    <span class="px-2 py-1 rounded text-xs font-semibold bg-red-100 text-red-800">Từ chối</span>
                    {% endif %}
                </td>
                <td class="px-4 py-2">{{ req.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
                <td class="px-4 py-2 space-x-2">
                    <div class="relative inline-block text-left">
                        <!-- Nút chính -->
                        <button onclick="toggleMenu(this)" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                            Hành động
                        </button>
                    
                        <!-- Menu ẩn -->
                        <div class="hidden absolute right-0 mt-2 w-32 bg-white border rounded shadow-lg z-10">
                            <a href="{{ url_for('admin.update_service_status', req_id=req.id, status='in_progress') }}"
                                class="block px-4 py-2 text-blue-600 hover:bg-gray-100 text-xs">Xử lý</a>
                            <a href="{{ url_for('admin.update_service_status', req_id=req.id, status='completed') }}"
                                class="block px-4 py-2 text-green-600 hover:bg-gray-100 text-xs">Hoàn thành</a>
                            <a href="{{ url_for('admin.update_service_status', req_id=req.id, status='rejected') }}"
                                class="block px-4 py-2 text-red-600 hover:bg-gray-100 text-xs">Từ chối</a>
                        </div>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="px-4 py-4 italic text-gray-500">Chưa có yêu cầu nào</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
        function toggleMenu(btn) {
            const menu = btn.nextElementSibling;
            menu.classList.toggle("hidden");
        }

        // Click ngoài thì tự đóng menu
        document.addEventListener("click", function (e) {
            document.querySelectorAll("[onclick='toggleMenu(this)']").forEach(button => {
                const menu = button.nextElementSibling;
                if (!button.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.add("hidden");
                }
            });
        });
    </script>
</div>

{% endblock %}