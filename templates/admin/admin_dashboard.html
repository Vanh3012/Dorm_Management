{% extends "admin/admin_base.html" %}
{% block content %}

{{ month }}
{{ year }}
<div class="p-6 space-y-6 bg-gray-50 min-h-screen">
    <!-- Header với bộ lọc -->
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <h1 class="text-3xl font-bold text-gray-800">Thống kê tổng quan Ký túc xá</h1>

            <!-- Bộ lọc -->
            <form method="GET" action="{{ url_for('admin.dashboard') }}" class="flex flex-wrap gap-3 items-center">
                <label class="text-sm font-medium text-gray-600">Lọc theo:</label>

                <select name="month"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                    {% for m in months %}
                    <option value="{{ m }}" {% if m==selected_month %}selected{% endif %}>
                        Tháng {{ m }}
                    </option>
                    {% endfor %}
                </select>

                <select name="year"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                    {% for y in years %}
                    <option value="{{ y }}" {% if y==selected_year %}selected{% endif %}>
                        {{ y }}
                    </option>
                    {% endfor %}
                </select>

                <button type="submit"
                    class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-sm hover:shadow-md">
                    Lọc
                </button>
            </form>
        </div>
    </div>

    <!-- Thống kê nhanh -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div
            class="bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-600 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
            <p class="text-blue-600 text-sm font-semibold mb-1"><a href="{{ url_for('admin.students')}}">Tổng sinh viên</a></p>
            <p class="text-4xl font-bold text-blue-700">{{ total_students }}</p>
        </div>

        <div
            class="bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-600 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
            <p class="text-green-600 text-sm font-semibold mb-1"><a href="{{ url_for('admin.manage_rooms')}}">Tổng phòng</a></p>
            <p class="text-4xl font-bold text-green-700">{{ total_rooms }}</p>
        </div>

        <div
            class="bg-gradient-to-br from-yellow-50 to-yellow-100 border-l-4 border-yellow-500 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
            <p class="text-yellow-600 text-sm font-semibold mb-1"><a href="{{ url_for('admin.payments')}}">Hóa đơn chưa thanh toán</a></p>
            <p class="text-4xl font-bold text-yellow-700">{{ unpaid_bills }}</p>
        </div>

        <div
            class="bg-gradient-to-br from-red-50 to-red-100 border-l-4 border-red-600 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
            <p class="text-red-600 text-sm font-semibold mb-1">Doanh thu tháng {{ selected_month }}/{{ selected_year }}
            </p>
            <p class="text-4xl font-bold text-red-700">{{ "{:,.0f}".format(total_revenue) }}đ</p>
        </div>
    </div>

    <!-- Biểu đồ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
        <!-- Biểu đồ doanh thu -->
        <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
            <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2"> Doanh thu theo loại dịch vụ</h2>
            <div class="h-64">
                <canvas id="serviceChart"></canvas>
            </div>
        </div>

        <!-- Biểu đồ sinh viên đăng ký -->
        <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
            <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">Sinh viên đăng ký</h2>
            <div class="h-64">
                <canvas id="registerChart"></canvas>
            </div>
        </div>

        <!-- Biểu đồ phòng -->
        <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
            <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2"> Tình trạng phòng</h2>
            <div class="h-64 flex items-center justify-center">
                <div style="max-width: 250px; width: 100%;">
                    <canvas id="roomChart" style="max-height: 300px"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Biểu đồ doanh thu theo loại dịch vụ
    const serviceChart = new Chart(document.getElementById('serviceChart'), {
        type: 'bar',
        data: {
            labels: {{ service_labels | tojson }},
    datasets: [{
        label: 'Doanh thu (VNĐ)',
        data: {{ service_values | tojson }},
        backgroundColor: '#3b82f6',
        borderRadius: 8,
        borderWidth: 0
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: {
                display: true,
                    position: 'bottom'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                    ticks: {
                    callback: function(value) {
                        return value.toLocaleString('vi-VN') + 'đ';
                    }
                }
            }
        }
    }
    });

    // Biểu đồ số sinh viên đăng ký mới
    const registerChart = new Chart(document.getElementById('registerChart'), {
        type: 'line',
        data: {
            labels: {{ reg_labels | tojson }},
    datasets: [{
        label: 'Số sinh viên đăng ký',
        data: {{ reg_values | tojson }},
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 5,
        pointBackgroundColor: '#10b981',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: {
                display: true,
                    position: 'bottom'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                    ticks: {
                    stepSize: 1
                }
            }
        }
    }
    });

    // Biểu đồ tình trạng phòng
    const roomChart = new Chart(document.getElementById('roomChart'), {
        type: 'doughnut',
        data: {
            labels: ['Phòng có người', 'Phòng trống'],
            datasets: [{
                data: [{{ occupied }}, {{ empty }}],
        backgroundColor: ['#ef4444', '#22c55e'],
        borderWidth: 0
    }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: true,
                plugins: {
            legend: {
                display: true,
                    position: 'bottom'
            }
        }
    }
    });
</script>

{% endblock %}